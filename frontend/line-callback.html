<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Care - LINE 登入</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .line-callback-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg, #f5f7fa);
        }
        .callback-card {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
            text-align: center;
            max-width: 420px;
            width: 100%;
        }
        .callback-card h2 { color: #06C755; margin-bottom: 8px; }
        .callback-card .subtitle { color: #666; margin-bottom: 24px; }
        .callback-card .error-text { color: #e74c3c; }

        .role-btn {
            display: block;
            width: 100%;
            padding: 16px;
            margin-top: 12px;
            border: 2px solid #ddd;
            border-radius: 12px;
            background: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .role-btn:hover { border-color: #06C755; background: #f0fff5; }

        .token-info {
            background: #f0f0f0;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            word-break: break-all;
            font-size: 12px;
            text-align: left;
        }
        .token-label { font-weight: bold; color: #333; margin-bottom: 4px; }
        .copy-btn {
            margin-top: 12px;
            padding: 8px 20px;
            background: #06C755;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        .copy-btn:hover { background: #05b34c; }

        .spinner-container { margin: 20px 0; }
        .line-spinner {
            width: 40px; height: 40px;
            border: 4px solid #e0e0e0;
            border-top-color: #06C755;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="line-callback-page">
        <div class="callback-card">
            <!-- Loading -->
            <div id="loadingView">
                <h2>LINE 登入處理中...</h2>
                <div class="spinner-container"><div class="line-spinner"></div></div>
            </div>

            <!-- Error -->
            <div id="errorView" class="hidden">
                <h2 class="error-text">登入失敗</h2>
                <p id="errorMessage" class="subtitle"></p>
                <a href="index.html" class="copy-btn" style="display:inline-block;text-decoration:none;">返回登入頁</a>
            </div>

            <!-- Role Selection (new user) -->
            <div id="roleView" class="hidden">
                <h2>歡迎，<span id="displayName"></span>！</h2>
                <p class="subtitle">請選擇您的角色</p>
                <button class="role-btn" onclick="completeRegistration('CUSTOMER')">
                    我是飼主（找保母）
                </button>
                <button class="role-btn" onclick="completeRegistration('SITTER')">
                    我是保母（接案）
                </button>
            </div>

            <!-- Login Success -->
            <div id="successView" class="hidden">
                <h2>LINE 登入成功！</h2>
                <p>歡迎回來，<strong id="successUsername"></strong></p>
                <p class="subtitle">正在跳轉至系統...</p>
                <div class="spinner-container"><div class="line-spinner"></div></div>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);

        document.addEventListener('DOMContentLoaded', () => {
            const error = params.get('error');
            if (error) {
                showError(decodeURIComponent(error));
                return;
            }

            const token = params.get('token');
            const registrationToken = params.get('registration_token');
            const displayName = params.get('display_name');

            if (token) {
                handleLoginSuccess(token);
            } else if (registrationToken) {
                showRoleSelection(registrationToken, displayName);
            } else {
                showError('無效的回調參數');
            }
        });

        function showView(viewId) {
            ['loadingView', 'errorView', 'roleView', 'successView'].forEach(id => {
                document.getElementById(id).classList.toggle('hidden', id !== viewId);
            });
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            showView('errorView');
        }

        async function handleLoginSuccess(accessToken) {
            try {
                // Decode JWT payload to get user info
                const payload = JSON.parse(atob(accessToken.split('.')[1]));

                const userData = {
                    userId: payload.userId,
                    username: payload.username,
                    role: payload.role,
                    email: payload.email
                };

                // Store token and user data
                sessionStorage.setItem(CONFIG.STORAGE_KEYS.ACCESS_TOKEN, accessToken);
                sessionStorage.setItem(CONFIG.STORAGE_KEYS.USER, JSON.stringify(userData));

                // Show success view (use LINE display name if available)
                const displayName = params.get('display_name');
                document.getElementById('successUsername').textContent = displayName ? decodeURIComponent(displayName) : userData.username;
                showView('successView');

                // Redirect based on role
                setTimeout(() => {
                    window.location.href = userData.role === 'CUSTOMER' ? 'customer.html' : userData.role === 'SITTER' ? 'sitter.html' : 'dashboard.html';
                }, 1500);
            } catch (e) {
                showError('Token 解析失敗：' + e.message);
            }
        }

        let currentRegistrationToken = null;

        function showRoleSelection(registrationToken, displayName) {
            currentRegistrationToken = registrationToken;
            document.getElementById('displayName').textContent = displayName || 'LINE 用戶';
            showView('roleView');
        }

        async function completeRegistration(role) {
            showView('loadingView');

            try {
                const displayName = document.getElementById('displayName').textContent || '';
                const response = await fetch(`${CONFIG.API_BASE_URL}/auth/oauth2/line/complete-registration`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        token: currentRegistrationToken,
                        role: role,
                        displayName: displayName
                    })
                });

                const data = await response.json();

                if (!response.ok || data.success === false) {
                    throw new Error(data.message || '註冊失敗');
                }

                // Use returned access token
                handleLoginSuccess(data.data.accessToken);
            } catch (e) {
                showError('註冊失敗：' + e.message);
            }
        }
    </script>
</body>
</html>
